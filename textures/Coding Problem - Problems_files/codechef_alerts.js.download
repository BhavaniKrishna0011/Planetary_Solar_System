const LAST_ALERT_ACK_ID="lastAlertAckId";const styles={maskStyle:{top:0,left:0,position:"fixed",display:"grid",placeItems:"center",height:"100vh",width:"100vw",zIndex:1e4,lineHeight:1.5,fontSize:"16px",backdropFilter:"blur(2px)",background:"rgba(0, 0, 0, 0.1)",boxSizing:"border-box"},boxStyle:{background:"white",width:"500px",borderRadius:"7px",gridArea:"1 / 1 / 1 / 1",padding:"20px",boxShadow:"1px 1px 5px rgba(0, 0, 0, 0.2)",boxSizing:"border-box"},headerStyle:{fontWeight:600,fontSize:"20px",marginBottom:"15px",justifyContent:"space-between",display:"flex",alignItems:"center"},headerContentStyle:{boxSizing:"border-box"},footerStyle:{display:"flex",flexDirection:"row-reverse",marginTop:"15px",boxSizing:"border-box"},okButtonStyle:{padding:"5px 20px",color:"white",borderRadius:"5px",background:"rgb(75 144 226)",cursor:"pointer",boxSizing:"border-box"}};const addCustomCSS=e=>{const t=document.createElement("style");t.type="text/css";t.appendChild(document.createTextNode(e));document.head.appendChild(t)};const generateElement=e=>{const t=document.createElement("div");if(e.class){t.className=e.class}if(e.style){Object.assign(t.style,e.style)}if(e.innerHTML){t.innerHTML=e.innerHTML}if(e.id){t.setAttribute("id",e.id)}if(e.onClick){t.addEventListener("click",e.onClick)}e.childs&&e.childs.forEach(e=>{t.appendChild(generateElement(e))});return t};function popUp(e,t){const s={style:styles.headerContentStyle,innerHTML:"IMPORTANT ANNOUNCEMENT"};const n={style:styles.headerStyle,childs:[s]};const i={innerHTML:e.message};const o={style:styles.okButtonStyle,innerHTML:"Okay",onClick:t};const a={style:styles.footerStyle,childs:[o]};const l={style:styles.boxStyle,childs:[n,i,a],class:"alert-box"};return generateElement(l)}class Mask{constructor(e){this.el=document.createElement("div");Object.assign(this.el.style,styles.maskStyle);this.el.style.display="none";e.appendChild(this.el)}show(){Object.assign(this.el.style,styles.maskStyle)}hide(){this.el.style.display="none"}}const broadcastMessage={send:(e,t)=>{window.localStorage.setItem("broadcast_"+e,JSON.stringify(t))},receive:(e,t)=>{window.addEventListener("storage",s=>{if(s.key=="broadcast_"+e){t(JSON.parse(s.newValue))}})}};class AlertManager{constructor(e){this.alerts=[];this.showMask=false;this.mask=new Mask(e);const t=".alert-box p { font-size: 16px; }";addCustomCSS(t);broadcastMessage.receive("alerts",e=>{this.remove(e.id)});this.loadFromCookies()}add(e){if(this.alerts.length===0){this.showMask=true}this.alerts.push(e);this.render()}remove(e){this.alerts=this.alerts.filter(t=>t.id!=e);this.showMask=this.alerts.length!==0;this.render()}removeTop(){this.alerts.shift();this.showMask=this.alerts.length!==0;this.render()}removeAll(){this.alerts=[];this.render()}render(){this.showMask?this.mask.show():this.mask.hide();this.mask.el.innerHTML="";this.alerts.forEach((e,t)=>{const s=popUp(e,t=>{const s=e.target_audience;const n=s.type==="all"?"alerts-all":`contest_${s.contestCode}`;this.setLastAlertAckID(n,e.id);broadcastMessage.send("alerts",{id:e.id});this.removeTop()});s.style.position="relative";s.style.bottom=`${t*10}px`;s.style.left=`${t*10}px`;s.style.zIndex=`${(this.alerts.length-t)*1e5}`;this.mask.el.appendChild(s)})}getChannelKey(e){const t=e==="alerts-all"?"":Drupal.settings.username+":";return t+LAST_ALERT_ACK_ID+"_"+e}getLastAlertAckID(e){const t=window.localStorage.getItem(this.getChannelKey(e));return t||this.getCookie(this.getChannelKey(e))||-1}setLastAlertAckID(e,t){window.localStorage.setItem(this.getChannelKey(e),t);this.setCookie(this.getChannelKey(e),t,30);this.lastAlertAckId=t}setCookie(e,t,s){let n="";if(s){const e=new Date;e.setTime(e.getTime()+s*24*60*60*1e3);n="; expires="+e.toUTCString()}document.cookie=e+"="+(t||"")+n+"; path=/"}getCookie(e){const t=e+"=";const s=document.cookie.split(";");let n=null;s.forEach(e=>{e=e.trim();if(e.indexOf(t)===0){n=e.substring(t.length,e.length)}});return n}loadFromCookies(){const e=document.cookie.split(";");e.forEach(e=>{e=e.trim();if(e.includes(LAST_ALERT_ACK_ID)){const t=e.split("=");window.localStorage.setItem(t[0],t[1])}})}}function main(){const e=document.querySelector("body");const t=new AlertManager(e);let s=10;const n=()=>{const e=window.location.protocol==="https:"?"wss:":"ws:";const i=["alerts-all"];const o=Drupal.settings.visitedContests;if(o){i.push(...o.map(e=>"contest_"+e))}const a=new WebSocket(`${e}//${window.location.hostname}/ws/sub/${i.join()}`);a.addEventListener("open",()=>{window.isSocketConnOpen=true;const e=i.map(e=>`${e}=${t.getLastAlertAckID(e)}`).join("&");fetch("/api/alerts/recent?"+e).then(e=>e.json()).then(e=>{t.removeAll();e.alerts.forEach(e=>{t.add(e)})})});a.addEventListener("message",e=>{const s=JSON.parse(e.data);t.add(s)});a.addEventListener("close",e=>{window.isSocketConnOpen=false;if(e.code===4001){n()}else{s-- >0&&setTimeout(n,6e4)}});window.addEventListener("reconnectWebSocket",()=>{a.close(4001)})};n()}let isVisitedContestsReady=false;let isDrupalSettingsReady=false;window.addEventListener("drupalSettingsReady",()=>{isDrupalSettingsReady=true;isVisitedContestsReady&&!window.isSocketConnOpen&&main()});window.addEventListener("visitedContestsReady",()=>{isVisitedContestsReady=true;isDrupalSettingsReady&&!window.isSocketConnOpen&&main()});document.addEventListener("DOMContentLoaded",()=>{if("Drupal"in window&&"settings"in Drupal&&"username"in Drupal.settings&&"visitedContests"in Drupal.settings){window.dispatchEvent(new Event("drupalSettingsReady"));window.dispatchEvent(new Event("visitedContestsReady"))}});